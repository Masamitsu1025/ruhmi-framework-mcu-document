<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Masamitsu Muratani" /><link rel="canonical" href="https://Masamitsu1025.github.io/ruhmi-framework-mcu-document/scripts/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>How to scripts - ruhmi-framework-mcu-documents</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "How to scripts";
        var mkdocs_page_input_path = "scripts\\README.md";
        var mkdocs_page_url = "/ruhmi-framework-mcu-document/scripts/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> ruhmi-framework-mcu-documents
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../install/">Installation guide</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">How to scripts</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../doc/runtime_api/">Handling optput source code</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../doc/mera_api/">API Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../doc/operator_support/">Supported operators</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../doc/error_list/">error list</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../doc/tips/">FAQ & Tips</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">ruhmi-framework-mcu-documents</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">How to scripts</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h2 id="introduction">Introduction</h2>
<p>The section introduces how to execute the model compilation with the sample scripts for each exmple case below. <br />
<em> <a href="#How-to-deploy-models">Deploy models</a><br />
  - Deploy to CPU only <br />
  - Deploy to CPU with NPU/Ethos U55 supported  <br />
</em> <a href="#How-to-quantize-and-deploy-models">Quantize and deploy models</a>
  - Deploy to CPU only <br />
  - Deploy to CPU with NPU/Ethos U55 supported  <br />
The sample scripts are <a href="../scripts/">here</a></p>
<p>You can run each script under the virtual environment showing the prompt like "(.venv) PS C:\work&gt;".</p>
<h2 id="conversion-options">Conversion options</h2>
<p>The introduced scripts here supports each option. You can use the script depending on the case below.
<img alt="" src="../docs/material/conversion_options.gif" /></p>
<p>[NOTICE]
Some options has NOT been supported yet. If you have seen the message like below after runingn the script, please understand it's not ready yet.</p>
<pre><code>If you input the onnx model with the script, mcu_deploy.py, you will receive the message like below.
Quantization to be needed at first.

Found unsupported model files:
  - C:\[working folder]\models_int8\*.onnx

UNAVAILABLE: Feature not available yet. Direct deployment supports only FP32/INT8 .tflite.
For .onnx or .pte, quantize with mcu_quantize.py first.
</code></pre>
<h1 id="how-to-deploy-models">How to deploy models</h1>
<p>The sample script shows how to use the deployment API to compile an already quantized TFLite model on a board with Ethos-U55 support.  </p>
<p>This release introduces some tested models. As the example model,we can download <a href="https://raw.githubusercontent.com/mlcommons/tiny/master/benchmark/training/anomaly_detection/trained_models/ad01_int8.tflite">ad01_int8.tflite</a> and <a href="https://raw.githubusercontent.com/mlcommons/tiny/master/benchmark/training/anomaly_detection/trained_models/ad01_fp32.tflite">ad01_fp32.tflite</a> from <a href="https://github.com/mlcommons">MLCommons</a>  <br />
When runing the scripts provided in the repository, you shall build the folder configuration including each model.  </p>
<p>The directory configuration for the sample scripts to run is below.</p>
<pre><code>  ├── scripts
  |     ├── mcu_deploy.py  // sample script for deploy
  |     └── mcu_quantize.py  // sample script for quantize and deploy
  ├── models_int8                                                                        // To be prepared
  |     └── ad01_int8.tflite  // sample model to iput to deployer from MLCommons
  ├── models_fp32                                                                        // To be prepared
  |     └── ad01_fp32.tflite  // sample model to input to Quantizer from MLCommons
  ├── models_fp32_ethos                                                                  // To be prepared
  |     └── ad01_fp32.tflite  // sample model to input to Quantizer from MLCommons
</code></pre>
<blockquote>
<p>[!TIP]
If you see any warnings in the process below, you can refer <a href="../doc/tips/">Tips</a></p>
</blockquote>
<h3 id="deploy-to-cpu-only">Deploy to CPU only</h3>
<p>By running the provided script <strong>scripts/mcu_deploy.py</strong>. we can compile the model for MCU only:  </p>
<pre><code>cd scripts/  
python mcu_deploy.py --ref_data ../models_int8 deploy_qtzed  
</code></pre>
<h3 id="deploy-to-cpu-with-ethos-u55-supported">Deploy to CPU with Ethos U55 supported</h3>
<p>When enabling Ethos-U support:  </p>
<pre><code>cd scripts  
python mcu_deploy.py --ethos --ref_data ../models_int8 deploy_qtzed_ethos  
 ```

### Check the deploy result

you will get the following results:
</code></pre>
<pre><code>deploy_qtzed
├── ad01_int8_no_ospi
</code></pre>
<pre><code>
When Ethos-U support is enabled, each of the directories contain a deployment of the corresponding model for MCU + Ethos-U55 platform:  
</code></pre>
<p>└── [ad01_int8_no_ospi]  # an example for "ad01_int8_no_ospi"<br />
    ├── build<br />
        ├── MCU<br />
            ├── compilation<br />
                ├── mera.plan<br />
                ├── src     # compilation results: C source code and C++ testing support code # HAL entry example<br />
                    ├── CMakeLists.txt<br />
                    ├── compare.cpp<br />
                    ├── compute_sub_0000.c # CPU subgraph generated C source code<br />
                    ├── compute_sub_0000.h<br />
                    ├── ...<br />
                    ├── ethosu_common.h<br />
                    ├── hal_entry.c<br />
                    ├── kernel_library_int.c # kernel library if CPU subgraphs are present<br />
                    ├──  ...<br />
                    ├── model.c<br />
                    ├── model.h<br />
                    ├── model_io_data.c<br />
                    ├── model_io_data.h<br />
                    ├── python_bindings.cpp<br />
                    ├── sub_0001_command_stream.c # Ethos-U55 subgraph generated C source code<br />
                    ├── sub_0001_command_stream.h<br />
                    ├── sub_0001_invoke.c<br />
                    ├── sub_0001_invoke.h<br />
                    ├──  ...<br />
                ├──  ...<br />
            ├── deploy_cfg.json<br />
            ├── ir_dumps<br />
                ├── person-det_can.dot<br />
                ├── ...<br />
            ├── person-det_after_canonicalization.dot<br />
            ├── person-det_subgraphs.dot<br />
    ├── logs<br />
    ├──　model<br />
        ├── input_desc.json<br />
    ├── project.mdp  </p>
<pre><code>
The generated C code under **&quot;build/MCU/compilation/src&quot;** can be incorporated into a e2studio project.  
You can refer to [Guide to the generated C source code](/docs/runtime_api.md) to study how to use the output file from RUHMI Framework.  

# How to quantize and deploy models 

If the starting point it is a Float32 precision model, it is possible to use the Quantizer to first quantize the model and finally deploy with MCU/Ethos-U55 support.
The sample script with using the Quantizer can be refered.

For an example model, the same model in FP32 shall be used [ad01_fp32.tflite](https://github.com/mlcommons/tiny/blob/master/benchmark/training/anomaly_detection/trained_models/ad01_fp32.tflite) from  [MLCommons](https://github.com/mlcommons)  


### Deploy to CPU only   

To run the script:
</code></pre>
<p>cd scripts/<br />
python mcu_quantize.py ../models_fp32 deploy_mcu   </p>
<pre><code>
### Deploy to CPU with Ethos U55 supported   
</code></pre>
<p>cd scripts/<br />
python mcu_quantize.py -e ../models_fp32_ethos deploy_ethos  </p>
<pre><code>
### Check the quantize and deploy result   

When Ethos-U support is enabled, each of the directories contain a deployment of the corresponding model for MCU + Ethos-U55 platform:  
</code></pre>
<p>C:\work\scripts\deploy_ethos\model_000_ad01_fp32\deploy_mcu\build\MCU\compilation</p>
<p>[deploy_ethos]
└── [model_000_ad01_fp32]  # an example for "ad01_fp32.tflite"<br />
        ├── [deploy_mcu]  <br />
        ├── build<br />
            ├── MCU<br />
                ├── compilation<br />
                    ├── mera.plan<br />
                    ├── src     # compilation results: C source code and C++ testing support code # HAL entry example<br />
                        ├── CMakeLists.txt<br />
                        ├── compare.cpp<br />
                        ├── compute_sub_0000.c # CPU subgraph generated C source code<br />
                        ├── compute_sub_0000.h<br />
                        ├── ...<br />
                        ├── ethosu_common.h<br />
                        ├── hal_entry.c<br />
                        ├── kernel_library_int.c # kernel library if CPU subgraphs are present<br />
                        ├──  ...<br />
                        ├── model.c<br />
                        ├── model.h<br />
                        ├── model_io_data.c<br />
                        ├── model_io_data.h<br />
                        ├── python_bindings.cpp<br />
                        ├── sub_0001_command_stream.c # Ethos-U55 subgraph generated C source code<br />
                        ├── sub_0001_command_stream.h<br />
                        ├── sub_0001_invoke.c<br />
                        ├── sub_0001_invoke.h<br />
                        ├──  ...<br />
                    ├──  ...<br />
```</p>
<p>The generated C code under <strong>"build/MCU/compilation/src"</strong> can be incorporated into a e2studio project.<br />
You can refer to <a href="/docs/runtime_api.md">Guide to the generated C source code</a> to study how to use the output file from RUHMI Framework.  </p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../install/" class="btn btn-neutral float-left" title="Installation guide"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../doc/runtime_api/" class="btn btn-neutral float-right" title="Handling optput source code">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../install/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../doc/runtime_api/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
